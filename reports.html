<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<title>WSPR reports</title>
<style>
body
{ 
	margin:0px;
	padding:0px;
	border:0px;
	font-family:Arial; 
	font-size:16px;
	background-color:#FFF; 
	white-space: nowrap;
}

table, th, td
{
	text-align:center;
  	border: 2px solid black;
	border-collapse:collapse;
	padding:2px;
}

th{ font-family:Arial, Helvetica, sans-serif; font-size:20px; background-color:#090; color:#FFF; }
td{ font-family: "Lucida Console", Monaco, monospace; font-size:24px; line-height:24px }
</style>

<script type="text/javascript">

// VARIABLEN

// XML Http-Request-Element
var _XhrElem;

// Die Statuszeile links neben der Ueberschrift
var _statusOut;

// Die WSPR-Daten
var _wsprData;


// FUNKTIONEN

// HTTP-Request-Objekt erzeugen
function createCORSRequest()
{
	var xhr = new XMLHttpRequest();
	if ("withCredentials" in xhr)
	{
		// Check if the XMLHttpRequest object has a "withCredentials" property.
		// "withCredentials" only exists on XMLHTTPRequest2 objects.
	}
	else if (typeof XDomainRequest != "undefined")
	{
		// Otherwise, check if XDomainRequest.
		// XDomainRequest only exists in IE, and is IE's way of making CORS requests.
		xhr = new XDomainRequest();
	}
	else
	{
		// Otherwise, CORS is not supported by the browser.
		xhr = null;
	}
	return xhr;
}

function rcvRequest()
{
	// Die Anzeige-Div
	var el = document.getElementById("output");

	try
	{
		if( _XhrElem.response != "" )
		{
			// Statusanzeige updaten
			_statusOut.innerHTML = "showing data ..." ;
		
			// json-Inhalt in Objekt konvertieren
			_wsprData = JSON.parse(_XhrElem.response);
		}
		else
		{
			// Statusanzeige updaten
			_statusOut.innerHTML = "no data available" ;
			return ;
		}
	}
	catch (e)
	{
		// json data is corrupt
		el.innerHTML = _XhrElem.response;
		return;
	}
	
	var htmlout = "<pre>";
	var slotnum, slotidx, repnum, repidx, reparr, rep, srcnum, srcidx, src ;
	var call, grid, band, pwr, RXF, pre, SNR;
	
	// Alle Slots bearbeiten (720 2m-Slots pro Tag, revers)
	slotnum = _wsprData.slot.length ;
	for ( slotidx=slotnum ; slotidx >= 0 ; slotidx-- )
	{
		reparr = _wsprData.slot[slotidx];
		if( reparr == null )
			continue ;

		// slotidx in hh:mm-String umrechnen
		var min = slotidx * 2 ;
		var hh = parseInt(min / 60 );
		var mm = min - 60*hh ; 
		hh = hh.toString();
		if( hh.length < 2 )
			hh = "0" + hh ;
		mm = mm.toString();
		if( mm.length < 2 )
			mm = "0" + mm ;
			
		var repnum = reparr.length ;
		for( repidx=repnum-1 ; repidx >= 0 ; repidx-- )
		{
			rep = reparr[repidx];
			
			if( rep == null )
				continue ;
				
			call = rep.call;
			while( call.length < 12 )
				call = " " + call;
				
			grid = rep.grid;
			while( grid.length < 7 )
				grid = " " + grid;
				
			band = rep.band;
			while( band.length < 6 )
				band = " " + band;
				
			pwr = rep.pwr;
			while( pwr.length < 4 )
				pwr = " " + pwr;
				
			htmlout += hh +":" + mm + " " + call + grid + band + " " + pwr + "   ";;

			srcnum = rep.srcArray.length ;
			for( srcidx=0 ; srcidx < srcnum ; srcidx++ )
			{
				src = rep.srcArray[srcidx];

				// Pruefen, ob fuer diese Spalte nichts vorhanden ist
				if( src == null )
				{
					// Gibt es ueberhaupt einen Report in dieser Spalte
					if( _wsprData.repcnt[srcidx] > 0 )
					{
						htmlout += "                " + "     ";
					}
					continue;
				}

				if( typeof src.RXF != "undefined" )
				{
					RXF = src.RXF ;
					
					var pre = "";
					if( RXF < 100 )
						pre = " " ;
					if( RXF < 10 )
						pre = "  " ;
						
					RXF = pre + src.RXF.toString();
					
					while( RXF.length < 11 )
						RXF = RXF + "0";
				
					SNR = src.SNR;
					while( SNR.length < 4 )
						SNR = " " + SNR;
				
					htmlout += RXF + " " + SNR;
				}
				else
				{
					htmlout += "** NO RECEIVE **";
				}
				
				htmlout += "     ";
			}
			
			htmlout += "<br>";
		}
	}
	htmlout += "</pre>";
	
	// Seite ausgeben
	el.innerHTML = htmlout ;
	
	// Statusanzeige updaten
	_statusOut.innerHTML = "" ;
}

function reqError()
{
	alert("reqError");
}

function start()
{
	// Die Statusanzeige updaten
	_statusOut = document.getElementById("status");
	_statusOut.innerHTML = "loading data ..." ;
	
	// Http-Request-Element erzeugen
	_XhrElem = createCORSRequest();

	// Funktionen an Request-Element zuweisen
	_XhrElem.onload = rcvRequest;
	_XhrElem.onerror = reqError;

	// Das aktuelle Datum formatieren
	var d = new Date();
	var date = ( d.getFullYear() - 2000 ) * 10000 + (d.getMonth()+1) * 100 + d.getDate();
	
	// Die aktuelle Datendatei 
//	var jsonfile = "./database/" + date.toString() + "_wsprdat.json" ;
jsonfile = "./request.php" ;

	// WSPR-Daten anfordern
	_XhrElem.open('get', jsonfile, true);
	_XhrElem.send();

}

// Main
window.onload = start ;	

</script>
</head>
<body>
<p><span style="font-size:24px; margin-right:20px">DF5FH WSPR-Monitor</span><span style="font-family:courier; fontsize:10px" id="status">()</status></p>
<span style="margin-right:50px"><a href="querypara.html">Specify Query Parameters</a></span><span><a href="filterpara.html">Specify Filter Parameters</a></span> 

<div id="output"></div>

</body>
